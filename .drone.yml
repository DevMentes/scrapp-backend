kind: pipeline
name: scrapp-backend

steps:
  - name: test
    image: node:11-alpine
    commands:
      - npm install
      - npm run test

  - name: publish
    image: plugins/gcr
    settings:
      repo: getcolors/scrapp-backend
      dockerfile: Dockerfile
      tags: latest
      json_key:
        from_secret: google_credentials

  - name: deploy
    image: google/cloud-sdk:alpine
    environment:
      google_credentials:
        from_secret: google_credentials
      docker_user:
        from_secret: docker_user
      docker_password:
        from_secret: docker_password
    commands:
      - echo $google_credentials > /tmp/$CI_PIPELINE_ID.json
      - gcloud auth activate-service-account --key-file /tmp/$CI_PIPELINE_ID.json
      - gcloud compute ssh scrapp-backend --zone us-east1-b --command "sudo docker login -u _json_key -p '$google_credentials'"
      - gcloud compute ssh scrapp-backend --zone us-east1-b --command "sudo docker run -d -p 80:3000 --restart always --env-file ./../../env.list gcr.io/getcolors/scrapp-backend:latest"